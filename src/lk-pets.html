//= template/header.html
//= template/breadcrumbs.html
<div class="box">
    <div class="header">
        <h1>Личный кабинет</h1>
    </div>
</div>
<div class="box">
    <div class="profile d-grid">
        <div class="profile-aside">
           <ul class="personal-menu">
                <li><a href="lk-main.html"><span class="p-menu__icon"><svg width="23" height="20"><use href="sprite/sprite.svg#personal-home" /></svg></span>Главная</a></li>
                <li><a href="lk-history.html"><span class="p-menu__icon"><svg width="23" height="21"><use href="sprite/sprite.svg#personal-history" /></svg></span>История заказов</a></li>
                <li><a href="lk-bonus.html"><span class="p-menu__icon"><svg width="27" height="23"><use href="sprite/sprite.svg#personal-bonus" /></svg></span>Мои БонУСы</a></li>
                <li><a class="active" href="lk-pets.html"><span class="p-menu__icon"><svg width="27" height="24"><use href="sprite/sprite.svg#personal-pets" /></svg></span>Мои Питомцы</a></li>
                <li><a href="lk-messages.html"><span class="p-menu__icon"><svg width="24" height="22"><use href="sprite/sprite.svg#personal-mess" /></svg></span>Сообщения</a></li>
                <li><a href="lk-favorite.html"><span class="p-menu__icon"><svg width="22" height="19"><use href="sprite/sprite.svg#m_fav" /></svg></span>Избранное</a></li>
                <li><a href="lk-profile.html"><span class="p-menu__icon"><svg width="22" height="22"><use href="sprite/sprite.svg#personal-profile" /></svg></span>Профиль</a></li>
                <li><a href="lk-delivery.html"><span class="p-menu__icon"><svg width="18" height="23"><use href="sprite/sprite.svg#personal-delivery" /></svg></span>Адреса доставки</a></li>
                <li><a href="lk-feedback"><span class="p-menu__icon"><svg width="21" height="18"><use href="sprite/sprite.svg#personal-feedback" /></svg></span>Обратная связь</a></li>
                <li><a href="?logout=Y"><span class="p-menu__icon"><svg width="21" height="18"><use href="sprite/sprite.svg#personal-out" /></svg></span>Выйти</a></li>
            </ul>
        </div>
        <div class="profile-main">
            <div class="header"><h3>Мои Питомцы</h3></div>
            <div class="pets d-grid">
                <!--питомец-->
                <div class="pets-item flex">
                    <div class="corner-controls">
                        <div class="corner-controls__button"><svg><use href="sprite/sprite.svg#points"></use></svg></div>
                        <div class="corner-controls__block">
                            <span class="corner-edit" data-modal="pet"><svg><use href="sprite/sprite.svg#pencil"></use></svg>Редактировать</span>
                            <a class="corner-delete"><svg><use href="sprite/sprite.svg#bucket"></use></svg>Удалить</a>
                        </div>
                    </div>
                    <div class="pets-item__inner flex">
                        <div class="pets-item__img">
                            <img src="img/test/lk/dog.png" alt="dog" />
                        </div>
                        <div class="pets-item__info">
                            <div class="pet-name">Оливер Оливеравава11111111111111111 </div>
                            <div class="pet-breed">Корги</div>
                            <div class="pet-age"><span class="bold">1 год</span>&nbsp;<span>(8 января 2022)</span></div>
                        </div>
                    </div>
                </div>
                <!-- // -->

                <!--питомец-->
                <div class="pets-item flex">
                    <div class="corner-controls">
                        <div class="corner-controls__button"><svg>
                                <use href="sprite/sprite.svg#points"></use>
                            </svg></div>
                        <div class="corner-controls__block">
                            <span class="corner-edit" data-modal="pet"><svg><use href="sprite/sprite.svg#pencil"></use></svg>Редактировать</span>
                            <a class="corner-delete"><svg><use href="sprite/sprite.svg#bucket"></use></svg>Удалить</a>
                        </div>
                    </div>
                    <div class="pets-item__inner flex">
                        <div class="pets-item__img">
                            <img src="img/test/lk/dog.png" alt="dog" />
                        </div>
                        <div class="pets-item__info">
                            <div class="pet-name">Марго</div>
                            <div class="pet-breed">Сиамская сторожевая</div>
                            <div class="pet-age"><span class="bold">1 год</span>&nbsp;<span>(8 января 2022)</span></div>
                        </div>
                    </div>
                </div>
                <!-- // -->

                <!--Добавление-->
                <div class="pets-item --add-pet flex" data-modal="pet">
                    <div class="pets-item__inner flex">
                        <div class="roundAdd__icon">
                            <svg><use href="sprite/sprite.svg#plus"></use></svg>
                        </div>
                        <div class="roundAdd__text">
                            Добавить питомца
                        </div>
                    </div>
                </div>
                <!-- // -->
            </div>
        </div>
    </div>
</div>


<div class="modal modal-pet" id="modal-pet">
    <form action="" class="js-checkPetForm modal-inner">
        <div class="modal-title">Добавить питомца</div>
        <div class="m-addForm d-grid b-border">
            <div class="m-addForm__file">

                <!--Загрузка картинки-->
                <!--Если картинка есть, то прописываем display:none -->
                <div class="upload-area" id="upload-area">
                    <div class="m-addForm__file-label">Фотография питомца</div>
                    
                    <div class="drag-frame" id="drop_zone">
                        <div class="drag-frame-inner">
                            <div class="upload-icon"></div>
                            <div class="upload-note">
                                Перетащите фото мышкой или нажмите выбрать (.png, .jpg, .jpeg)
                                Размер — не более 10 МБ
                            </div>
                            <div class="upload-button">
                                <input name="file" type="file" id="avatar__file" class="avatar__file" />
                                <button class="btn btn-fill r5">Выбрать</button>
                            </div>
                        </div>
                    </div>

                    <div class="upload-controls is_hidden">
                        <div class="result-avatar-buttons">
                            <button type="button" class="save-avatar" id="upload-save">Применить</button>
                            <button type="button" class="upload-avatar" id="upload-other">Заменить</button>
                            <button type="button" class="delete-avatar" id="upload-delete">Удалить</button>
                        </div>
                    </div>
                </div>
                
                <!--Загруженная картинки-->

                <div class="result-avatar" style="display: none;">
                    <div class="result-avatar-preview">
                        <!--Если картинка есть, то прописываем сюда и убираем display:none выше-->
                        <img src="img/test/lk/dog.png" alt="dog" />
                    </div>
                    <div class="result-avatar-buttons">
                        <button type="button" class="upload-avatar" id="edit-avatar">Заменить</button>
                        <button type="button" class="delete-avatar" id="delete-avatar">Удалить</button>
                    </div>
                </div>

            </div>
            <div class="m-addForm__form modal-fields">
                <div class="form-row">
                    <label>Кличка</label>
                    <input type="text" name="user-name" value="Анна" />
                </div>

                <div class="form-row flex-jcsb mobile-flex">
                    <div class="form-row-singlrselect">
                        <label>Дата рождения</label>
                    </div>
                    <div class="form-cell __select">
                        <select name="bitrth-day" style="width: 100%">
                            <option value="1">01</option>
                            <option value="2">02</option>
                            <option value="2">03</option>
                            <option value="2">04</option>
                        </select>
                    </div>
                    <div class="form-cell __select">
                        <select name="bitrth-mon" style="width: 100%">
                            <option value="1">Январь</option>
                            <option value="2">Февраль</option>
                            <option value="2">Март</option>
                            <option value="2">Апрель</option>
                        </select>
                    </div>
                    <div class="form-cell __select">
                        <select name="bitrth-year" style="width: 100%">
                            <option value="1">1999</option>
                            <option value="2">2000</option>
                            <option value="2">2001</option>
                            <option value="2">2002</option>
                        </select>
                    </div>
                </div>
            
                <div class="form-row">
                    <label>Вид животного</label>
                    <select name="type" style="width: 100%">
                        <option value="">Выберите вид:</option>
                        <option value="1">Собака</option>
                        <option value="2">Кошка</option>
                        <option value="2">Мышка</option>
                        <option value="2">Корова</option>
                    </select>
                </div>
            
                <div class="form-row">
                    <label>Порода</label>
                    <input type="text" name="user-name" placeholder="К примеру “Овчарка”" />
                </div>
            
                <div class="form-row">
                    <label>Разновидность</label>
                    <input type="text" name="user-name" placeholder="К примеру “Немецкая”" />
                </div>
            </div>
        </div>
        <div class="modal-bottom-buttons">
            <div class="form-cell __auto">
                <button class="js-closeModal btn btn-white r10">Отмена</button>
            </div>
            <div class="form-cell __auto">
                <button type=""submit class="btn btn-fill r10">Сохранить</button>
            </div>
        </div>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
<script>
    
    $(document).ready(function () {

         //Вызов попапа
        $('body').on('click', '[data-modal="pet"]', function () {
            $.fancybox.open({
                src: '#modal-pet',
                opts: {
                    touch: false,
                    afterShow: function (instance, current) {

                        //загрузка файла
                        $("html").on("dragover drop", function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                        });

                        $('body').on('dragover', '#drop_zone', function () {
                            $(this).addClass('drag_over');
                            return false;
                        });

                        $('body').on('dragleave', '#drop_zone', function () {
                            $(this).removeClass('drag_over');
                            return false;
                        });

                        avatarUpload();
                        
                    }
                }
            });
        });

        $('.js-checkPetForm').on('submit', function(evt){
            const requiredInput = $(this).find('[name="type"]');
            const errorText = 'Вид животного - обязательное поле';

            if( !requiredInput.val() ) {
                console.log('error');
                addError(requiredInput, errorText);

                evt.preventDefault();
            }

            requiredInput.on('change', removeError);

            function addError(input, errorText) {
                input.addClass('error');
                input.parents('.form-row').append(`<label class="error">${errorText}</label>`);
            }
            function removeError() {
                const input = $(this);
                input.removeClass('error');
                input.nextAll('label.error').remove();
            }
        });
    });

    function avatarUpload() {
            var $uploadCrop;
            const messBox = $('#avatar-form .js-result-message');
            function readFile(file) {
                if (file) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $('.upload-controls').removeClass('is_hidden');
                        $('#drop_zone').addClass('ready');
                        $('#drop_zone').removeClass('drag_over');
                        $uploadCrop.croppie('bind', {
                            url: e.target.result
                        }).then(function () {
                            console.log('complete');
                        });

                    }

                    reader.readAsDataURL(file);
                }
                else {
                    alert("Sorry - you're browser doesn't support the FileReader API");
                }
            }

            $uploadCrop = $('#drop_zone').croppie({
                viewport: {
                    width: 150,
                    height: 150,
                    type: 'circle'
                },
                boundary: {
                    width: 215,
                    height: 215
                },
                enableExif: true
            });

            $('#avatar__file').on('change', function () {
                console.log(this.files[0]['type']);
                if (this.files[0]['type'].indexOf('image') !== -1) {
                    if (validateSize(this.files[0], 1)) {
                        
                        readFile(this.files[0]);
                    } else {
                       alert('Файл не должен превышать 1 Мб!');
                        return false;
                    }

                } else {
                    alert('Возможна загрузка только изображения!');
                    return false;
                }

            });

            $("#drop_zone").on("drop", function (e) {
                e.preventDefault(); e.stopPropagation();
                let files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    if (files[0]['type'].indexOf('image') !== -1) {
                        if (validateSize(files[0], 1)) {
                            messBox.empty();
                            readFile(files[0]);
                        } else {
                            alert('Файл не должен превышать 1 Мб!');
                            return false;
                        }
                    } else {
                        alert('Возможна загрузка только изображения!');
                        return false;
                    }
                }
            });



            //Нажатие
            $('#upload-other').on('click', function () {
                $('#avatar__file').trigger('click');
            });

            //Нажатие на Удалить
            $('#upload-delete').on('click', function () {
                resetCroppie();
                $uploadCrop = $('#drop_zone').croppie({
                    viewport: {
                        width: 150,
                        height: 150,
                        type: 'circle'
                    },
                    boundary: {
                        width: 215,
                        height: 215
                    },
                    enableExif: true
                });
            });

            //Нажатие на кнопку Сохранить
            $('#upload-save').on('click', function (ev) {
                ev.preventDefault();
                $uploadCrop.croppie('result', {
                    type: 'canvas',
                    size: 'viewport',
                }).then(function (resp) {

                    let file = $('#avatar__file').prop('files')[0];
                    console.log(file);//данные файла


                    $('#upload-area').hide();

                    $resAvat = $('.result-avatar');
                    $resAvat.find('.result-avatar-preview').html('<img src="'+resp+'" />');
                    $resAvat.show();

                    //Всё сбрасываем 
                    resetCroppie();
                    $uploadCrop = $('#drop_zone').croppie({
                        viewport: {
                            width: 150,
                            height: 150,
                            type: 'circle'
                        },
                        boundary: {
                            width: 215,
                            height: 215
                        },
                        enableExif: true
                    });
             

                });
            });


             $('body').on('click', '#edit-avatar, #delete-avatar', function () {
                $(this).closest('.result-avatar').hide();
                $('#upload-area').show();
            })

        }



    function resetCroppie() {
        $('#upload').val('');
        $('#drop_zone').croppie('destroy');
        $('#drop_zone').removeClass('ready');
        $('.upload-controls').addClass('is_hidden');
    }

    //Ограничение размера - 
    function validateSize(file, sizeMb) {
        if (file.size > sizeMb * 1024 * 1024) {
            return false
        }
        return true;
    }
</script>

//= template/footer.html